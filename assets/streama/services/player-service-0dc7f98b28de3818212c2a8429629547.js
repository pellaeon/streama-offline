//# sourceMappingURL=player-service.js.map
angular.module("streama").factory("playerService",["$stateParams","$sce","$state","$rootScope","socketService","apiService","$interval","$filter","contextPath","$uibModal",function(d,m,e,f,h,g,k,l,n,p){var c=null,a,q={customStartingTime:0,rememberVolumeSetting:!0,videoMetaTitle:"",videoMetaSubtitle:"",videoMetaDescription:"",videoSrc:"",videoType:"",videoTrack:"",subtitleSize:"md",videoOverlayEnabled:!0,showEpisodeBrowser:!1,showNextButton:!1,showSocketSession:!0,showDownloadButton:!1,isAutoplayNextActive:!1,
episodeList:[],selectedEpisodes:[],currentEpisode:{},nextVideo:{},outro_start:null,subtitles:[],videoFiles:[],onSocketSessionCreate:angular.noop,onTimeChange:angular.noop,onError:angular.noop,onPlay:angular.noop,onPause:angular.noop,onClose:angular.noop,onNext:angular.noop,onVideoClick:angular.noop,onEditVideo:angular.noop};return{getVideoOptions:function(){return a},setVideoOptions:function(b,r){a=angular.copy(q);c=b;a.videoSrc=m.trustAsResourceUrl(b.defaultVideoFile.src||b.defaultVideoFile.externalLink);
a.originalFilename=b.defaultVideoFile.originalFilename;a.videoType=b.defaultVideoFile.contentType;a.selectedVideoFile=b.defaultVideoFile;a.showDownloadButton=f.isDownloadButtonVisible;b.videoFiles&&b.videoFiles.length&&(a.videoFiles=b.videoFiles);b.subtitles&&b.subtitles.length&&(a.subtitles=b.subtitles);a.isExternalLink=b.files[0].externalLink;a.videoMetaTitle=b.show?b.show.name:b.title;a.videoMetaSubtitle=b.show?b.episodeString+" - "+b.name:b.release_date?b.release_date.substring(0,4):"";a.videoMetaDescription=
b.overview;a.nextVideo=c.nextEpisode||c.nextVideo;a.isAutoplayNextActive=!!c.nextEpisode;a.outro_start=c.outro_start;a.nextVideo&&(a.showNextButton=!0);c.show&&(a.showEpisodeBrowser=!0,g.tvShow.episodesForTvShow(c.show.id).then(function(b){a.episodeList=_.groupBy(b.data,"season_number");a.selectedEpisodes=a.episodeList[c.season_number];a.currentEpisode={episode:c.episode_number,season:c.season_number,intro_start:c.intro_start,intro_end:c.intro_end}}));a.customStartingTime=d.currentTime?d.currentTime:
b.viewedStatus?b.viewedStatus.currentPlayTime:0;a.onPlay=this.onVideoPlay.bind(a);a.onPause=this.onVideoPause.bind(a);a.onError=this.onVideoError.bind(a);a.onTimeChange=this.onVideoTimeChange.bind(a);a.onClose=this.onVideoClose.bind(a);a.onNext=this.onNext.bind(a);a.onVideoClick=this.onVideoClick.bind(a);a.onSocketSessionCreate=this.onSocketSessionCreate.bind(a);a.onEditVideo=this.onEditVideo.bind(c,a);return a},viewingStatusSaveInterval:null,onVideoPlay:function(b,a){console.log("%c onVideoPlay",
"color: deeppink; font-weight: bold; text-shadow: 0 0 5px deeppink;");this.viewingStatusSaveInterval=k(function(){var a={videoId:c.id,currentTime:b.currentTime,runtime:b.duration};a.runtime&&a.videoId&&g.viewingStatus.save(a)},5E3);d.sessionId&&!a&&(console.log("%c send socket event PLAY","color: deeppink; font-weight: bold; text-shadow: 0 0 5px deeppink;"),g.websocket.triggerPlayerAction({socketSessionId:d.sessionId,playerAction:"play",currentPlayerTime:b.currentTime}))},onVideoPause:function(b,
a){console.log("%c onVideoPause","color: deeppink; font-weight: bold; text-shadow: 0 0 5px deeppink;",a);k.cancel(this.viewingStatusSaveInterval);d.sessionId&&a&&(b.currentTime+1.5>a.currentPlayerTime||b.currentTime-1.5<a.currentPlayerTime)&&(b.currentTime=a.currentPlayerTime);d.sessionId&&!a&&(console.log("%c send socket event PAUSE","color: deeppink; font-weight: bold; text-shadow: 0 0 5px deeppink;"),g.websocket.triggerPlayerAction({socketSessionId:d.sessionId,playerAction:"pause",currentPlayerTime:b.currentTime}))},
onVideoClose:function(){console.log("%c onVideoClose","color: deeppink; font-weight: bold; text-shadow: 0 0 5px deeppink;");e.go("dash",{})},onVideoError:function(b){"player"===e.current.name&&(console.log("onVideoError"),b=b||"CODEC_PROBLEM",p.open({templateUrl:"/streama/modal--error-report.htm",controller:"modalErrorReportCtrl",controllerAs:"vm",size:"lg",backdrop:"static",resolve:{errorCode:function(){return b},videoData:function(){return c}}}).result.then(function(b){}))},onVideoTimeChange:function(b,
a){g.viewingStatus.save({videoId:c.id,currentTime:b.value,runtime:a});d.sessionId&&g.websocket.triggerPlayerAction({socketSessionId:d.sessionId,playerAction:"timeChange",currentPlayerTime:b.value})},onSocketSessionCreate:function(){alertify.set({buttonReverse:!0,labels:{ok:"OK",cancel:"Cancel"}});alertify.confirm(l("translate")("MESSAGES.SHARE_SOCKET"),function(b){b&&(d.sessionId=h.getUUID(),e.go(e.current,d,{reload:!0}))})},onEditVideo:function(){c.show?e.go("admin.show",{showId:c.show.id,episodeId:c.id,
season:c.season_number}):e.go("admin.movie",{movieId:c.id})},handleMissingFileError:function(b){var a=!1;b.files&&b.files.length||(a=!0,alertify.alert(l("translate")("MESSAGES.FILE_MISSING"),function(){f.currentUser.authorities.length?b.show?e.go("admin.show",{showId:b.show.id}):e.go("admin.movie",{movieId:b.id}):e.go("dash",{})}));return a},handleWrongBasepathError:function(b){var a=!1,c=b.files[0].src;b=b.files[0].externalLink;var d=location.origin+n;c&&-1==c.indexOf(d)&&!b&&(a=!0,alertify.alert(l("translate")("MESSAGES.WRONG_BASEPATH",
{basePath:d}),function(){_.find(f.currentUser.authorities,{authority:"ROLE_ADMIN"})?e.go("settings.settings"):e.go("dash",{})}));return a},registerSocketListener:function(){d.sessionId&&h.registerPlayerSessonListener(d.sessionId)},destroyPlayer:function(){console.log("%c $stateChangeSuccess","color: deeppink; font-weight: bold; text-shadow: 0 0 5px deeppink;");k.cancel(this.viewingStatusSaveInterval);h.unsubscribe()},handleSocketEvent:function(a){if(a.browserSocketUUID!=h.browserSocketUUID)switch(console.log("%c handleSocketEvent",
"color: deeppink; font-weight: bold; text-shadow: 0 0 5px deeppink;"),a.playerAction){case "play":f.$broadcast("triggerVideoPlay",a);break;case "pause":f.$broadcast("triggerVideoPause",a);break;case "timeChange":f.$broadcast("triggerVideoTimeChange",a)}},onNext:function(){"undefined"!==typeof c.nextEpisode?e.go("player",{videoId:c.nextEpisode.id}):"undefined"!==typeof c.nextVideo&&e.go("player",{videoId:c.nextVideo.id})},onVideoClick:function(){f.currentUser.pauseVideoOnClick&&f.$broadcast("triggerVideoToggle")}}}]);